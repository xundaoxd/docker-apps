#!/usr/bin/env bash

self_path=$(realpath $0)
bin_path=$(dirname $self_path)
docker_path=$(dirname $bin_path)

base_opt() {
    echo "-u $(id -u):$(id -g) \
    -h $(hostname) \
    -v $docker_path/.home:$HOME \
    -e DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix \
    -e LANG -e GTK_IM_MODULE=xim -e QT_IM_MODULE=xim -e XMODIFIERS"
}

cwd_opt() {
    echo "-v $PWD:$PWD -w $PWD"
}

home_opt() {
    for f in $HOME/*; do
        ret="$ret -v $f:$f:ro"
    done
    echo $ret
}

home_nocwd_opt() {
    home_dir=$(home_opt)
    for tmp in $home_dir; do
        if [ $tmp='-v' ]; then
            continue
        fi
        dr=$(echo $tmp | cut -d ':' -f1)
        if [ $(realpath $dr)=$(realpath $PWD) ]; then
            continue
        fi
        ret="$ret -v $tmp"
    done
    echo $ret
}

pulse_opt() {
    echo "-e PULSE_SERVER=unix:/run/user/1000/pulse/native \
    -v /run/user/1000/pulse:/run/user/1000/pulse"
}

base() {
    docker run $(base_opt) $(cwd_opt) "$@"
}

# nodejs
node() {
    base -ti --rm node:latest node "$@"
}
npm() {
    base -ti --rm node:latest npm "$@"
}
yarn() {
    base -ti --rm node:latest yarn "$@"
}
npx() {
    base -ti --rm node:latest npx "$@"
}

# java
java() {
    base -ti --rm openjdk:latest java "$@"
}
javac() {
    base -ti --rm openjdk:latest javac "$@"
}

# go
go() {
    base -ti --rm xundaoxd/go:latest go "$@"
}

# cuda
nvcc() {
    base -ti --rm --gpus all xundaoxd/development:latest nvcc "$@"
}
nvdisasm() {
    base -ti --rm --gpus all xundaoxd/development:latest nvdisasm "$@"
}
cuobjdump() {
    base -ti --rm --gpus all xundaoxd/development:latest cuobjdump "$@"
}
cmake() {
    base -ti --rm --gpus all xundaoxd/development:latest cmake "$@"
}
bazel() {
    base -ti --rm --gpus all xundaoxd/development:latest bazel "$@"
}
vscode() {
    base --gpus all \
        -d --rm xundaoxd/vscode:latest \
        code --no-sandbox -w "$@"
}

# others
obsidian() {
    base $(home_nocwd_opt) --gpus all \
        -d --rm xundaoxd/obsidian:latest \
        /opt/obsidian/obsidian --no-sandbox "$@"
}
octave() {
    base -d --rm xundaoxd/octave:latest \
        octave --gui "$@"
}
vlc() {
    base $(pulse_opt) \
        -d --rm xundaoxd/vlc:latest \
        vlc "$@"
}
gimp() {
    base -d --rm xundaoxd/gimp:latest \
        gimp "$@"
}
manim() {
    base -v $(pwd):/manim \
        -ti --rm manimcommunity/manim:latest \
        manim "$@"
}
xelatex() {
    base -ti --rm texlive/texlive:latest \
        xelatex "$@"
}
doxygen() {
    base -ti --rm xundaoxd/doxygen:latest \
        doxygen "$@"
}
you-get() {
    base -ti --rm xundaoxd/you-get:latest \
        you-get "$@"
}
blender() {
    base $(pulse_opt) --gpus all \
        -d --rm xundaoxd/blender:latest /usr/bin/blender
}

main() {
    self=$(basename $0)
    $self "$@"
}

main "$@"
