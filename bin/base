#!/usr/bin/env bash

self_dir="$(cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd)"
proj_dir="$(dirname "$self_dir")"

home_dir="${proj_dir}/home"
target_home="/home/xundaoxd"

die() {
    echo "$@"
    exit 1
}

common_opts() {
    echo "-h $HOSTNAME --network host -e LANG -e GTK_IM_MODULE=xim -e QT_IM_MODULE=xim -e XMODIFIERS"
}

home_opts() {
    local opt="-v ${home_dir}:${target_home}"
    [[ -e $HOME/.local/share/fonts ]] && opt="$opt -v $HOME/.local/share/fonts:${target_home}/.local/share/fonts:ro"
    echo "$opt"
}

pwd_opts() {
    echo "-v $PWD:$PWD -w $PWD"
}

x11_opts() {
    local opt="-e DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix"
    [[ -e $HOME/.Xauthority ]] && opt="$opt -v $HOME/.Xauthority:$target_home/.Xauthority:ro"
    echo "$opt"
}

_base() {
    [[ $PWD != $HOME/* ]] && die "please run docker app in home dir!!!"

    local opts=""
    opts="$opts $(common_opts)"
    opts="$opts $(home_opts)"
    opts="$opts $(pwd_opts)"
    opts="$opts $(x11_opts)"

    read -ra opts <<< "${opts}"
    echo docker run "${opts[@]}" "$@"
    docker run "${opts[@]}" "$@"
}


mllab() {
    _base -ti --rm --gpus all ghcr.io/xundaoxd/ml:latest "$@"
}
ipython() {
    _base -ti --rm --gpus all ghcr.io/xundaoxd/ml:latest \
        ipython "$@"
}
jupyter() {
    _base -ti --rm --gpus all ghcr.io/xundaoxd/ml:latest \
        jupyter lab --no-browser --NotebookApp.token='' "$@"
}

main() {
    self=$(basename "$0")
    $self "$@"
}

main "$@"

