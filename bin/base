#!/usr/bin/env bash

self_path=$(realpath "${BASH_SOURCE[0]:-$0}")
self_dir=$(dirname "$self_path")
proj_dir=$(dirname "$self_dir")
current_dir="$(realpath "$PWD")"
home_dir="$(realpath "$HOME")"

die() {
    echo "$@"
    exit 1
}

common_opts() {
    echo "--network host -e LANG -e GTK_IM_MODULE=xim -e QT_IM_MODULE=xim -e XMODIFIERS"
}

home_opts() {
    local opt="-v $proj_dir/.home:$HOME"
    [[ -e $home_dir/.local/share/fonts ]] && opt="$opt -v $home_dir/.local/share/fonts:$HOME/.local/share/fonts:ro"
    echo "$opt"
}

pwd_opts() {
    echo "-v $current_dir:$PWD -w $PWD"
}

x11_opts() {
    local opt="-e DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix"
    [[ -e $home_dir/.Xauthority ]] && opt="$opt -v $home_dir/.Xauthority:$HOME/.Xauthority:ro"
    echo "$opt"
}

base() {
    [[ $current_dir != $home_dir/* ]] && die "Please run docker app in home dir!!!"

    local opts=""
    opts="$opts $(common_opts)"
    opts="$opts $(home_opts)"
    opts="$opts $(pwd_opts)"
    opts="$opts $(x11_opts)"

    read -ra opts <<< "${opts}"
    echo docker run "${opts[@]}" "$@"
    docker run "${opts[@]}" "$@"
}


mllab() {
    base -ti --rm --gpus all xundaoxd/ml:latest "$@"
}
ipython() {
    base -ti --rm --gpus all xundaoxd/ml:latest \
        ipython "$@"
}
jupyter() {
    base -ti --rm --gpus all xundaoxd/ml:latest \
        jupyter lab --no-browser --NotebookApp.token='' "$@"
}

# obsidian() {
#     base -d --rm --gpus all xundaoxd/obsidian obsidian --no-sandbox "$@"
# }

main() {
    self=$(basename "$0")
    $self "$@"
}

main "$@"

