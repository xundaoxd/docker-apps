#!/usr/bin/env bash

self_path=$(realpath "${BASH_SOURCE[0]:-$0}")
self_dir=$(dirname "$self_path")
proj_dir=$(dirname "$self_dir")
current_dir="$(realpath "$PWD")"
home_dir="$(realpath "$HOME")"

die() {
    echo "$@"
    exit 1
}

x11_opts() {
    local opt="-e DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix"
    [[ -e $home_dir/.Xauthority ]] && opt="$opt -v $home_dir/.Xauthority:$HOME/.Xauthority:ro"
    echo "$opt"
}

home_opts() {
    local opt="-v $proj_dir/.home:$HOME"
    [[ -e $home_dir/.local/share/fonts ]] && opt="$opt -v $home_dir/.local/share/fonts:$HOME/.local/share/fonts:ro"
    echo "$opt"
}

base() {
    [[ $PWD != $HOME/* ]] && die "Please run docker app in home dir!!!"

    opt="--network host \
        -u $(id -u):$(id -g) \
        -e LANG -e GTK_IM_MODULE=xim -e QT_IM_MODULE=xim -e XMODIFIERS \
        $(home_opts) \
        $(x11_opts) \
        -v $current_dir:$PWD \
        -w $PWD"

    echo docker run $opt "$@"
    docker run $opt "$@"
}


mllab() {
    base -ti --rm --gpus all xundaoxd/ml:latest "$@"
}
ipython() {
    base -ti --rm --gpus all xundaoxd/ml:latest \
        ipython "$@"
}
jupyter() {
    base -ti --rm --gpus all xundaoxd/ml:latest \
        jupyter lab --no-browser --NotebookApp.token='' "$@"
}

# obsidian() {
#     base -d --rm --gpus all xundaoxd/obsidian obsidian --no-sandbox "$@"
# }

main() {
    self=$(basename $0)
    $self "$@"
}

main "$@"

